"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.WxApi=exports.AUTH_ERROR_API_TOKEN_EXPIRED=exports.AUTH_ERROR_GET_WX_CODE=exports.AUTH_ERROR_EXCEED_MAX_COUNT=void 0;var _createClass=function(){function o(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,t,r){return t&&o(e.prototype,t),r&&o(e,r),e}}(),_lodash=require("../npm/lodash/lodash.js"),_promisify=require("../_utils/promisify.js"),_uri=require("../_utils/uri.js"),_wxPromisify=require("../_utils/wxPromisify.js"),_index=require("../npm/@tarojs/taro-weapp/index.js"),_index2=_interopRequireDefault(_index),_wxrequest=require("./wxrequest.js"),_wxrequest2=_interopRequireDefault(_wxrequest);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _objectWithoutProperties(e,t){var r={};for(var o in e)0<=t.indexOf(o)||Object.prototype.hasOwnProperty.call(e,o)&&(r[o]=e[o]);return r}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var baseDefaultDto=function(e){return e},AUTH_TOKEN="token",AUTH_ERROR_EXCEED_MAX_COUNT=exports.AUTH_ERROR_EXCEED_MAX_COUNT="AUTH_ERROR_EXCEED_MAX_COUNT",AUTH_ERROR_GET_WX_CODE=exports.AUTH_ERROR_GET_WX_CODE="AUTH_ERROR_GET_WX_CODE",AUTH_ERROR_API_TOKEN_EXPIRED=exports.AUTH_ERROR_API_TOKEN_EXPIRED="9000",WxApi=exports.WxApi=function(){function e(){var n=this;_classCallCheck(this,e),this.serviceApi={},this.$authTestCount=0,this.$interceptorDto=function(e,t){var r=e.resolve,o=_objectWithoutProperties(e,["resolve"]).requestData;n.$wxAuthFilter(o,t,r)},this.$requestService=(0,_wxrequest2.default)()}return _createClass(e,[{key:"$getReqData",value:function(e,t){var r=this.$getProtocol(),o=(0,_lodash.extend)({},r,{param:t}),n=this.$getYourCustomServiceConfig();return this.serviceApi=(0,_lodash.extend)({},this.serviceApi,n),{url:this.get("serviceApi."+e),data:o}}},{key:"get",value:function(e,t){return this.getFromSource(this,e,t)}},{key:"getFromSource",value:function(e,t,r){if(r=r||this.getEnvName()||"prod",!t)throw new Error("the `key` is required!");var o=(0,_lodash.get)(e,""+t,void 0);return(0,_lodash.isObject)(o)&&(0,_lodash.get)(o,""+r,void 0)||o}},{key:"getEnvName",value:function(){try{return(0,_uri.getQueryString)("env")||_index2.default.getStorageSync("env")||"prod"}catch(e){return console.log("core.ApiEnvConfig.getEnvName()",e),"prod"}}},{key:"$getYourCustomServiceConfig",value:function(){return{}}},{key:"$getProtocol",value:function(){return{protocol:{fromPlatform:this.$getPlatform()}}}},{key:"$getPlatform",value:function(){return"xm-wx-app"}},{key:"$preRequest",value:function(t){try{var e=_index2.default.getStorageSync(AUTH_TOKEN)||"";if(!e)return this.$wxLogin().then(function(e){return(0,_lodash.set)(t,"data.protocol.code",e.code),t}).catch(function(e){console.log("wx-web-api->$wxLogin().code: ",e)});(0,_lodash.set)(t,"data.protocol.token",e)}catch(e){console.log("wx-web-api->$preRequest().token: ",e)}return this.$promiseResult(t)}},{key:"$promiseResult",value:function(t){return(0,_promisify.promisify)(function(e){return(0,e.resolve)(t)})({})}},{key:"$wxLogin",value:function(){return(0,_wxPromisify.wxPromisify)("login")}},{key:"$wxAuthFilter",value:function(e,t,r){var o=this,n=e.data,i=t.data;return i.code!==AUTH_ERROR_API_TOKEN_EXPIRED?(this.$saveTokenToStorage(i),r(i)):(console.log("this.$authTestCount:",this.$authTestCount),2<=this.$authTestCount?r({code:AUTH_ERROR_EXCEED_MAX_COUNT,message:"[code]置换token失败次数过多!",data:{}}):(this.$authTestCount++,void this.$wxLogin().then(function(e){if(!e.code)return r({code:AUTH_ERROR_GET_WX_CODE,message:e.errMsg});(0,_lodash.set)(n,"protocol.code",e.code),o.$requestPost(n).then(function(e){e.code!==AUTH_ERROR_API_TOKEN_EXPIRED&&(o.$authTestCount=0),"0000"===e.code&&o.$saveTokenToStorage(e),r(e)})})))}},{key:"$saveTokenToStorage",value:function(e){var t=(0,_lodash.get)(e,"token","")||(0,_lodash.get)(e,"data.token","");t&&(_index2.default.setStorageSync(AUTH_TOKEN,t),console.log("saveAuthTokenSync: ",t))}},{key:"$adjustParameter",value:function(e,t,r){var o=1<arguments.length&&void 0!==t?t:{},n=2<arguments.length&&void 0!==r?r:{},i=baseDefaultDto;return(0,_lodash.isPlainObject)(e)&&(o=(0,_lodash.extend)({},e.data,o),e=e.url),o.dto&&(i=o.dto,delete o.dto),{url:e,data:o,dto:i,config:n}}},{key:"$request",value:function(e,t,r,o){var n=this,i=2<arguments.length&&void 0!==r?r:{},u=o,s=this.$adjustParameter(t,i,u);return this.$preRequest(s).then(function(t){return n.$requestService[e](t.url,t.data,t.config).then(function(e){return(0,_promisify.promisify)(n.$interceptorDto)({requestData:t},e).then(function(e){return t.dto.call(n,e)})})}).catch(function(e){throw new Error(e)})}},{key:"$requestPost",value:function(e,t,r){var o=1<arguments.length&&void 0!==t?t:{},n=2<arguments.length&&void 0!==r?r:{};return this.$request("POST",e,o,(0,_lodash.extend)({},n))}},{key:"$requestGet",value:function(e,t,r){var o=1<arguments.length&&void 0!==t?t:{},n=2<arguments.length&&void 0!==r?r:{};return this.$request("GET",e,o,(0,_lodash.extend)({},n))}}]),e}();