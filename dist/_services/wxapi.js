!function(e,t,i){"use strict";i.defineProperty(e,"__esModule",{value:!0}),e.WxApi=e.AUTH_ERROR_API_TOKEN_EXPIRED=e.AUTH_ERROR_GET_WX_CODE=e.AUTH_ERROR_EXCEED_MAX_COUNT=void 0;var o=function(e,t,o){return t&&r(e.prototype,t),o&&r(e,o),e};function r(e,t){for(var o=0;o<t.length;o++){var r=t[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),i.defineProperty(e,r.key,r)}}var u=t("../npm/lodash/lodash.js"),s=t("../_utils/promisify.js"),n=t("../_utils/uri.js"),a=t("../_utils/wxPromisify.js"),c=v(t("../npm/@tarojs/taro-weapp/index.js")),l=v(t("./wxrequest.js"));function v(e){return e&&e.__esModule?e:{default:e}}function f(e){return e}var d="token",h=e.AUTH_ERROR_EXCEED_MAX_COUNT="AUTH_ERROR_EXCEED_MAX_COUNT",g=e.AUTH_ERROR_GET_WX_CODE="AUTH_ERROR_GET_WX_CODE",p=e.AUTH_ERROR_API_TOKEN_EXPIRED="9000";e.WxApi=(o($,[{key:"$getReqData",value:function(e,t){var o=this.$getProtocol(),r=(0,u.extend)({},o,{param:t}),n=this.$getYourCustomServiceConfig();return this.serviceApi=(0,u.extend)({},this.serviceApi,n),{url:this.get("serviceApi."+e),data:r}}},{key:"get",value:function(e,t){return this.getFromSource(this,e,t)}},{key:"getFromSource",value:function(e,t,o){if(o=o||this.getEnvName()||"prod",!t)throw new Error("the `key` is required!");var r=(0,u.get)(e,""+t,void 0);return(0,u.isObject)(r)&&(0,u.get)(r,""+o,void 0)||r}},{key:"getEnvName",value:function(){try{return(0,n.getQueryString)("env")||c.default.getStorageSync("env")||"prod"}catch(e){return console.log("core.ApiEnvConfig.getEnvName()",e),"prod"}}},{key:"$getYourCustomServiceConfig",value:function(){return{}}},{key:"$getProtocol",value:function(){return{protocol:{fromPlatform:this.$getPlatform()}}}},{key:"$getPlatform",value:function(){return"xm-wx-app"}},{key:"$preRequest",value:function(t){try{var e=c.default.getStorageSync(d)||"";if(!e)return this.$wxLogin().then(function(e){return(0,u.set)(t,"data.protocol.code",e.code),t}).catch(function(e){console.log("wx-web-api->$wxLogin().code: ",e)});(0,u.set)(t,"data.protocol.token",e)}catch(e){console.log("wx-web-api->$preRequest().token: ",e)}return this.$promiseResult(t)}},{key:"$promiseResult",value:function(t){return(0,s.promisify)(function(e){return(0,e.resolve)(t)})({})}},{key:"$wxLogin",value:function(){return(0,a.wxPromisify)("login")}},{key:"$wxAuthFilter",value:function(e,t,o){var r=this,n=e.data,i=t.data;return i.code!==p?(this.$saveTokenToStorage(i),o(i)):(console.log("this.$authTestCount:",this.$authTestCount),2<=this.$authTestCount?o({code:h,message:"[code]置换token失败次数过多!",data:{}}):(this.$authTestCount++,void this.$wxLogin().then(function(e){if(!e.code)return o({code:g,message:e.errMsg});(0,u.set)(n,"protocol.code",e.code),r.$requestPost(n).then(function(e){e.code!==p&&(r.$authTestCount=0),"0000"===e.code&&r.$saveTokenToStorage(e),o(e)})})))}},{key:"$saveTokenToStorage",value:function(e){var t=(0,u.get)(e,"token","")||(0,u.get)(e,"data.token","");t&&(c.default.setStorageSync(d,t),console.log("saveAuthTokenSync: ",t))}},{key:"$adjustParameter",value:function(e,t,o){var r=1<arguments.length&&void 0!==t?t:{},n=2<arguments.length&&void 0!==o?o:{},i=f;return(0,u.isPlainObject)(e)&&(r=(0,u.extend)({},e.data,r),e=e.url),r.dto&&(i=r.dto,delete r.dto),{url:e,data:r,dto:i,config:n}}},{key:"$request",value:function(e,t,o,r){var n=this,i=2<arguments.length&&void 0!==o?o:{},u=r,a=this.$adjustParameter(t,i,u);return this.$preRequest(a).then(function(t){return n.$requestService[e](t.url,t.data,t.config).then(function(e){return(0,s.promisify)(n.$interceptorDto)({requestData:t},e).then(function(e){return t.dto.call(n,e)})})}).catch(function(e){throw new Error(e)})}},{key:"$requestPost",value:function(e,t,o){var r=1<arguments.length&&void 0!==t?t:{},n=2<arguments.length&&void 0!==o?o:{};return this.$request("POST",e,r,(0,u.extend)({},n))}},{key:"$requestGet",value:function(e,t,o){var r=1<arguments.length&&void 0!==t?t:{},n=2<arguments.length&&void 0!==o?o:{};return this.$request("GET",e,r,(0,u.extend)({},n))}}]),$);function $(){var n=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,$),this.serviceApi={},this.$authTestCount=0,this.$interceptorDto=function(e,t){var o=e.resolve,r=function(e,t){var o={};for(var r in e)0<=t.indexOf(r)||i.prototype.hasOwnProperty.call(e,r)&&(o[r]=e[r]);return o}(e,["resolve"]).requestData;n.$wxAuthFilter(r,t,o)},this.$requestService=(0,l.default)()}}(exports,require,Object);